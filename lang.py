import os
from typing import Dict
import streamlit as st
from openai import OpenAI


def build_prompt(metrics: Dict[str, float], school: str) -> str:
    return f'''
אתה מומחה הערכה חינוכית המתמחה בכתיבת פידבק למנהלי בתי ספר. המטרה שלך היא לנתח תוצאות של תוכנית "הציר המנטלי" - תוכנית חינוכית לפיתוח דפוס חשיבה מתפתח בקרב תלמידי כיתות ח' ו-י'.

## הקשר התוכנית
"הציר המנטלי" נועד לפתח דפוס חשיבה מתפתח - האמונה שיכולות ניתנות לפיתוח דרך מאמץ ותרגול, בניגוד לתפיסה שיכולות הן קבועות מלידה. התוכנית פועלת 6 חודשים ומטרתה לחזק מסוגלות עצמית וגישה חיובית ללמידה.

## המדדים (הסבר פשוט למנהל):
1. דפוס חשיבה מתפתח (Ref): האמונה שאפשר להשתפר עם מאמץ ותרגול
2. חוסן (ici): יכולת החזרה מקשיים ומכשלונות
3. מיקוד שליטה פנימי (risc): ההרגשה שאני יכול להשפיע על מה שקורה לי
4. תפיסת זמן - עתיד (Future): מיקוד במטרות ותכנון ארוך טווח
5. תפיסת זמן - עבר חיובי (Past Positive): זיכרונות חיוביים ותחושת זהות בריאה
6. תפיסת זמן - עבר שלילי (Past Negative): עיסוק יתר בזיכרונות שליליים ותחושות חרטה
7. הווה דוניסטי (Present Hedonistic): חיפוש הנאה והתמקדות בהווה
8. פטליזם בהווה (Present Fatalism): האמונה ש"מה שיהיה יהיה" וחוסר אמונה ביכולת להשפיע

## המבנה הנדרש לפידבק:
1. כותרת: "פידבק הערכה: תוכנית הציר המנטלי - {school}"
2. התפתחות חיובית (100-120 מילים)
3. אתגרים לתשומת לב (80-100 מילים)
4. שאלות לחשיבה (4 שאלות ממוקדות)
5. משפט סיכום (20-30 מילים)

## כללי כתיבה:
- השתמש בשפה פשוטה וחמה, ללא ז'רגון אקדמי
- הסבר ממצאים במונחים חינוכיים מובנים
- הדגש שזה לא "מבחן" אלא כלי לשיפור
- כלול מספרי שינוי (חיובי/שלילי) בסוגריים
- התמקד בתובנות פרקטיות לא בסטטיסטיקות

## נקודות חשובות:
- תן דגש מיוחד לדפוס חשיבה מתפתח (המטרה המרכזית)
- שים לב לקשרים בין מדדים (למשל: עלייה בשליטה פנימית אבל ירידה בדפוס מתפתח)
- הצע הסברים אפשריים לפרדוקסים
- שאלות לחשיבה צריכות להיות מעשיות ומובילות לפעולה

עכשיו נתח את הנתונים הבאים וכתוב פידבק בהתאם. השתמש בערכי השינוי (דלתא) בסוגריים לאחר כל ממצא מרכזי:

אלו נתוני שינוי בין השאלון הראשון לשני באחוזי שינוי  , בתוך המלצותך הסבר את המדדים :
        ref- דפוס חשיבה מתפתח - האמונה שאפשר להשתפר עם מאמץ ותרגול - {metrics.get('ref')} 
       ici - מיקוד שליטה פנימי - מודד את יכולת התלמידים להתמודד עם אתגרים ומצבי לחץ. ערכים גבוהים מעידים על חוסן גבוה - {metrics.get('ici')}
       risc - חוסן -  מודד את האמונה של התלמידים ביכולתם לשלוט בחייהם. ערכים גבוהים מעידים על תחושת שליטה עצמית חזקה יותר - {metrics.get('risc')}
       future_negetive_past -  עבר שלילי - תפיסה שלילית של העבר, טראומות וחוויות קשות - {metrics.get('future_negetive_past')}
       future_positive_past -  עבר חיובי - תפיסה חיובית של העבר, נוסטלגיה וזכרונות טובים - {metrics.get('future_positive_past')}
       present_deterministic -  הווה דטרמיניסטי - תפיסה פטליסטית של ההווה, חוסר שליטה - {metrics.get('present_deterministic')}
       present_hedonistic -  הווה הדוניסטי - תפיסת הווה הדוניסטית, חיפוש הנאות מיידיות - {metrics.get('present_hedonistic')}
       future_future -  עתיד - יכולת תכנון קדימה, דחיית סיפוקים, הצבת מטרות - {metrics.get('future_future')}

        הסבר את המדדים בצורה ברורה ומעמיקה, תוך מתן דוגמאות מעשיות לשימוש בהם.
        שים לב שאתה מדבר עם מנהלי בית ספר שלא מכירים את המושגים המקצועיים. דבר אליהם בשפה פשוטה ומפורטת והסבר כל דבר לעומק.

דוגמא לטקסט:
*פידבק הערכה: תוכנית הציר המנטלי - בית הספר דימונה*

תלמידי בית הספר הציגו שינויים מעניינים במהלך השנה, עם תמונה מעורבת של התפתחות בתחומים חשובים.

## התפתחות חיובית
*יחס בריא לזמן ולמאמצים:* תלמידיכם פיתחו יחס חיובי יותר לעברם (+0.4%) ומוקד יותר על הנאות ההווה (+0.84%). זה אומר שהם מעריכים יותר את החוויות החיוביות שעברו ונהנים מההווה. בנוסף, הם רואים יותר את עצמם כמי שיכולים להשפיע על מה שקורה להם (+0.32%) ומתמקדים יותר במטרות עתידיות (+0.26%).

*חוזק נפשי מוגבר:* חל שיפור ביכולת החזרה מקשיים ומכשלונות (+0.26) - זה אומר שהתלמידים מתמודדים טוב יותר עם אתגרים.

## אתגרים לתשומת לב
*דפוס חשיבה מתפתח:* כאן יש ירידה משמעותית (-0.34%), מה שמעיד שהתלמידים פחות מאמינים שיכולותיהם יכולות להשתפר עם מאמץ ותרגול. זה דווקא המדד המרכזי שהתוכנית נועדה לחזק.

*גישה פטליסטית:* גדלה הנטייה להאמין ש"מה שיהיה יהיה" (+0.47%), מה שעלול לפגוע במוטיבציה לפעול ולהשפיע.

## שאלות לחשיבה
1. *מה יכול לגרום לפער* בין השיפור ב"אני יכול להשפיע" לבין הירידה ב"אני יכול להשתפר"?
2. *האם התמקדות חזקה בהנאה מההווה* עוזרת או פוגעת במטרות לטווח ארוך?
3. *איך לנצל את החיזוק בזיכרונות חיוביים* כדי לחזק גם את האמונה ביכולת השיפור?
4. *מה אפשר לשנות בתוכנית* כדי לחזק יותר את המסר "עם תרגול ומאמץ אני משתפר"?

התוצאות מראות תוכנית בעלת פוטנציאל גבוה עם נקודות\u00A0להתמקדות\u00A0בהמשך

write with markup markdown and markup 
'''


def generate_report(metrics: Dict[str, float], school: str, model: str = "gpt-4o", temperature: float = 0.1) -> str:
    client = OpenAI()
    prompt = build_prompt(metrics, school)
    resp = client.chat.completions.create(
        model=model,
        messages=[
            {"role": "system", "content": "את/ה מסייע/ת בניתוח נתונים בעברית."},
            {"role": "user", "content": prompt},
        ],
        temperature=temperature,
    )
    return resp.choices[0].message.content.strip()  # type: ignore[attr-defined]

def run(metrics, school_name):
    generate_report(metrics, school_name)
    st.write(generate_report(metrics, school_name))
    
if __name__ == "__main__":
    # Example usage with dummy values
    example_metrics = {
        "ref": 0.3,
        "risc": 0.2,
        "ici": 0.1,
        "future_future": 0.15,
        "future_positive_past": 0.2,
        "future_negetive_past": -0.1,
        "future_hedonistic_present": 0.05,
        "future_fatalic_present": -0.05,
    }
    school_name = "בית ספר לדוגמה"
    print(generate_report(example_metrics, school_name))
import os
